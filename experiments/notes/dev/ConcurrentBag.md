# ConcurrentBag<T> 개요

`ConcurrentBag<T>`은 .NET의 `System.Collections.Concurrent` 네임스페이스에 포함된 **스레드-세이프(동기화된) 컬렉션 클래스**입니다.
**순서가 중요하지 않은 항목의 저장 및 가져오기 작업에 최적화**되어 있으며, 내부적으로 각 스레드에 로컬 저장소를 제공하여 **경합을 줄이고 성능을 높이는 구조**로 설계되어 있습니다.

---

## ✅ 주요 특징

| 항목                         | 설명                                                                       |
| ---------------------------- | -------------------------------------------------------------------------- |
| **스레드 안전(Thread-safe)** | 여러 스레드가 동시에 `Add`/`TryTake` 등의 작업을 안전하게 수행 가능        |
| **순서를 보장하지 않음**     | 항목을 저장한 순서대로 나오지 않으며, 순서가 중요한 경우에는 적합하지 않음 |
| **비교적 빠른 성능**         | 락을 적게 사용하고, 각 스레드마다 로컬 큐를 사용하는 구조로 설계됨         |
| **복사 (ToArray)**           | 현재 상태의 내용을 `배열`로 복사 가능                                      |
| **LINQ 지원**                | `IEnumerable<T>`를 구현하므로 LINQ 쿼리 사용 가능                          |

---

## 🧪 사용 예제

```csharp
var bag = new ConcurrentBag<string>();

// 항목 추가
bag.Add("apple");
bag.Add("banana");

// 항목 가져오기 (삭제 포함)
if (bag.TryTake(out var item))
{
    Console.WriteLine($"꺼낸 항목: {item}");
}

// 읽기 전용 접근
foreach (var fruit in bag)
{
    Console.WriteLine(fruit);
}
```

---

## 🧩 내부 구조 요약

- 각 스레드마다 **로컬 큐(Local Queue)** 를 유지
- `Add`는 로컬 큐에 바로 추가 → 락 없음
- `TryTake`는 먼저 로컬 큐에서 꺼내고, 없으면 다른 스레드의 큐도 시도
- 이런 구조 덕분에 **다수의 스레드가 자주 접근해도 경합이 적음**

---

## 🆚 다른 Concurrent 컬렉션 비교

| 컬렉션 타입             | FIFO      | 스레드 안전 | 주요 사용 목적                     |
| ----------------------- | --------- | ----------- | ---------------------------------- |
| `ConcurrentQueue<T>`    | ✅ 예     | ✅          | 순서 보장, 큐 처리에 적합          |
| `ConcurrentStack<T>`    | ❌ (LIFO) | ✅          | 스택 구조가 필요한 상황            |
| `ConcurrentBag<T>`      | ❌ 없음   | ✅          | 순서 불필요, 빠른 처리             |
| `BlockingCollection<T>` | 옵션      | ✅          | 생산자-소비자 패턴 등 제한 큐 구현 |

---

## 🛠 활용 예시

- 병렬 작업에서 **중간 결과 임시 저장소**로 사용
- **중복 허용**이 가능한 로그, 이벤트 수집 용도
- **멀티스레드 환경에서 빠르게 모으는 리스트 용도**

---

## ⚠️ 주의사항

- 순서를 보장하지 않기 때문에 **정렬 또는 특정 순서가 필요한 경우에는 부적합**
- `TryTake`은 성공 여부에 따라 처리 흐름을 분기해야 하며, **항상 값을 가져올 수 있는 것은 아님**

---

## 📌 정리

`ConcurrentBag<T>`은 고성능이 필요한 병렬 환경에서 **빠르게 항목을 수집하고 처리할 수 있는 컬렉션**입니다.
순서가 중요하지 않고, 중복이 허용되며, 많은 스레드가 동시에 접근하는 구조에서 탁월한 효율을 발휘합니다.
