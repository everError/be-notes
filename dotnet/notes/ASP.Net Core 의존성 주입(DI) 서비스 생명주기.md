# ASP.NET Core 의존성 주입(DI) 서비스 생명주기

ASP.NET Core에서 의존성 주입(DI)은 서비스의 인스턴스가 언제 생성되고 얼마나 오래 유지될지를 결정하는 **생명주기(Lifetime)**를 지정하는 기능을 제공합니다.

---

## ## 🚀 Transient (일회성)

`Transient` 생명주기로 등록된 서비스는 DI 컨테이너에 요청될 때마다 **항상 새로운 인스턴스가 생성**됩니다. 이는 세 가지 생명주기 중 가장 짧은 기간입니다.

### 주요 특징

- 서비스를 요청하는 모든 지점에서 각각 다른 인스턴스를 받게 됩니다.
- 상태를 저장하지 않는(stateless) 서비스에 적합합니다.

### 언제 사용할까?

- 상태 공유가 필요 없는 가볍고 간단한 서비스
- 호출마다 완벽한 격리가 보장되어야 하는 서비스 (예: gRPC 인터셉터)

### 주의할 점

- `Scoped` 또는 `Singleton` 생명주기를 가진 서비스에 `Transient` 서비스를 주입하면, 해당 `Transient` 서비스는 상위 서비스의 생명주기에 종속되어 사실상 한 번만 생성됩니다. 이를 **Captive Dependency**라고 하며, `Transient`의 의도와 다르게 동작하게 됩니다.

---

## ## 🌐 Scoped (요청 범위)

`Scoped` 서비스는 특정 **스코프(Scope) 내에서 단 한 번만 생성**됩니다. 생성된 인스턴스는 해당 스코프가 유지되는 동안 모든 요청에 대해 동일한 인스턴스를 반환합니다. ASP.NET Core 웹 애플리케이션에서 '스코프'는 **하나의 HTTP 요청**에 해당합니다.

### 주요 특징

- HTTP 요청이 시작될 때 인스턴스가 생성되며, 요청이 끝날 때 폐기(dispose)됩니다.
- 같은 HTTP 요청 내에서 여러 서비스가 동일한 `Scoped` 서비스 인스턴스를 공유합니다.

### 언제 사용할까?

- 하나의 HTTP 요청이라는 작업 단위(Unit of Work) 내에서 상태를 유지해야 할 때 (예: Entity Framework의 `DbContext`)
- 요청과 관련된 데이터를 공유하거나 캐시해야 할 때

### 주의할 점

- `Singleton` 서비스의 생성자에 `Scoped` 서비스를 주입해서는 안 됩니다. `Singleton`은 애플리케이션 시작 시 한 번 생성되므로, 주입된 `Scoped` 서비스 역시 `Singleton`의 생명주기를 따라가게 되어 스코프의 의미가 사라지고 메모리 누수 등의 문제를 유발할 수 있습니다.

---

## ## 🏛️ Singleton (단일 인스턴스)

`Singleton` 서비스는 애플리케이션 전체 생명주기 동안 **단 하나의 인스턴스만 생성**됩니다. 최초 요청 시 인스턴스가 생성되며, 이후 모든 요청은 해당 인스턴스를 공유합니다.

### 주요 특징

- 애플리케이션 내의 모든 요청과 모든 서비스가 항상 동일한 인스턴스를 공유합니다.
- 애플리케이션이 종료될 때 인스턴스가 폐기됩니다.

### 언제 사용할까?

- 애플리케이션 설정(`IConfiguration`), 로깅(`ILoggerFactory`) 등 전역적으로 공유되어야 하는 서비스
- 생성 비용이 비싸 한 번만 생성하여 재사용해야 하는 서비스
- 인메모리 캐시(In-memory Cache)와 같이 애플리케이션 전반에서 공유할 상태를 관리하는 서비스

### 주의할 점

- **스레드 안전성(Thread Safety)**을 반드시 고려해야 합니다. 여러 스레드(요청)가 동시에 `Singleton` 인스턴스의 상태를 변경할 경우 데이터 충돌이 발생할 수 있습니다.
- 애플리케이션이 종료될 때까지 메모리를 계속 차지하므로, 많은 메모리를 사용하는 서비스는 신중하게 등록해야 합니다.

---

### ## 요약 비교

| 생명주기      | 생성 시점                     | 인스턴스 공유 범위               | 주요 사용 사례                              |
| :------------ | :---------------------------- | :------------------------------- | :------------------------------------------ |
| **Transient** | 요청될 때마다 매번            | 공유되지 않음 (항상 새 인스턴스) | 가벼운 상태 없는 서비스, 격리가 필요한 객체 |
| **Scoped**    | 스코프(HTTP 요청)마다         | 같은 스코프(HTTP 요청) 내        | DB Context, 요청 단위 데이터 공유           |
| **Singleton** | 애플리케이션에서 최초 요청 시 | 애플리케이션 전체                | 설정, 로깅, 캐시 등 전역 서비스             |
